<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OTP Input</title>
    <link rel="stylesheet" href="../../base/tokens.css" />
    <link rel="stylesheet" href="otp-input.css" />
    <style>
      body {
        font-family: var(--mdst-font-sans);
        padding: var(--mdst-space-md);
        display: flex;
        flex-direction: column;
        gap: var(--mdst-space-md);
      }

      label {
        display: block;
        font-size: var(--mdst-text-sm);
        margin-bottom: var(--mdst-space-xs);
        color: var(--mdst-color-muted);
      }

      .example {
        display: flex;
        flex-direction: column;
        gap: var(--mdst-space-xs);
      }
    </style>
  </head>
  <body>
    <div class="example">
      <label>4-digit code</label>
      <div class="mdst-otp">
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
      </div>
    </div>

    <div class="example">
      <label>6-digit code with separator</label>
      <div class="mdst-otp">
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <span class="mdst-otp-separator"></span>
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" placeholder="0" />
      </div>
    </div>

    <div class="example">
      <label>Error state</label>
      <div class="mdst-otp mdst-otp--error">
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="1" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="2" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="3" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="4" />
      </div>
    </div>

    <div class="example">
      <label>Success state</label>
      <div class="mdst-otp mdst-otp--success">
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="1" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="2" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="3" />
        <input type="text" maxlength="1" class="mdst-otp-digit" inputmode="numeric" value="4" />
      </div>
    </div>

    <script>
      function createOTPInput(container, options) {
        options = options || {};
        var onComplete = options.onComplete || function () {};
        var onChange = options.onChange || function () {};

        var inputs = Array.from(container.querySelectorAll(".mdst-otp-digit"));

        if (inputs.length === 0) {
          console.warn("createOTPInput: No .mdst-otp-digit elements found");
          return null;
        }

        function getValue() {
          return inputs
            .map(function (input) {
              return input.value;
            })
            .join("");
        }

        function setValue(value) {
          var digits = value.replace(/\D/g, "").split("");
          inputs.forEach(function (input, i) {
            input.value = digits[i] || "";
          });
          onChange(getValue());
        }

        function clear() {
          inputs.forEach(function (input) {
            input.value = "";
          });
          onChange("");
        }

        function focus() {
          if (inputs[0]) inputs[0].focus();
        }

        function focusInput(index) {
          var target = inputs[Math.max(0, Math.min(index, inputs.length - 1))];
          if (target) {
            target.focus();
            target.select();
          }
        }

        function checkComplete() {
          var value = getValue();
          onChange(value);
          if (value.length === inputs.length && value.indexOf("") === -1) {
            onComplete(value);
          }
        }

        function handleInput(e) {
          var input = e.target;
          var index = inputs.indexOf(input);

          if (input.value.length > 1) {
            input.value = input.value.slice(-1);
          }

          input.value = input.value.replace(/\D/g, "");

          if (input.value && index < inputs.length - 1) {
            focusInput(index + 1);
          }

          checkComplete();
        }

        function handleKeyDown(e) {
          var input = e.target;
          var index = inputs.indexOf(input);

          switch (e.key) {
            case "Backspace":
              if (!input.value && index > 0) {
                e.preventDefault();
                focusInput(index - 1);
                inputs[index - 1].value = "";
                onChange(getValue());
              }
              break;

            case "Delete":
              input.value = "";
              onChange(getValue());
              break;

            case "ArrowLeft":
              e.preventDefault();
              focusInput(index - 1);
              break;

            case "ArrowRight":
              e.preventDefault();
              focusInput(index + 1);
              break;
          }
        }

        function handlePaste(e) {
          e.preventDefault();
          var pastedData = e.clipboardData.getData("text");
          var digits = pastedData.replace(/\D/g, "").split("");
          var startIndex = inputs.indexOf(e.target);

          digits.forEach(function (digit, i) {
            var targetIndex = startIndex + i;
            if (targetIndex < inputs.length) {
              inputs[targetIndex].value = digit;
            }
          });

          var nextEmptyIndex = inputs.findIndex(function (input) {
            return !input.value;
          });
          focusInput(nextEmptyIndex === -1 ? inputs.length - 1 : nextEmptyIndex);

          checkComplete();
        }

        function handleFocus(e) {
          e.target.select();
        }

        inputs.forEach(function (input) {
          input.addEventListener("input", handleInput);
          input.addEventListener("keydown", handleKeyDown);
          input.addEventListener("paste", handlePaste);
          input.addEventListener("focus", handleFocus);
        });

        function destroy() {
          inputs.forEach(function (input) {
            input.removeEventListener("input", handleInput);
            input.removeEventListener("keydown", handleKeyDown);
            input.removeEventListener("paste", handlePaste);
            input.removeEventListener("focus", handleFocus);
          });
        }

        return {
          getValue: getValue,
          setValue: setValue,
          clear: clear,
          focus: focus,
          destroy: destroy,
        };
      }

      document.querySelectorAll(".mdst-otp").forEach(function (container) {
        createOTPInput(container, {
          onComplete: function (code) {
            console.log("OTP complete:", code);
          },
          onChange: function (code) {
            console.log("OTP changed:", code);
          },
        });
      });
    </script>
  </body>
</html>
